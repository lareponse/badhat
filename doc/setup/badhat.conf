### /etc/apache2/badhat/badhat.conf
DocumentRoot ${SITE_ROOT}/public

###############################################
# Environment Detection
###############################################
# Set BADHAT_ENV in your Apache config:
#   - DEV: Development (permissive, no HSTS, HTTP-compatible)
#   - PROD: Production (strict, HSTS enabled, HTTPS-only)
#
# Example in site config:
#   SetEnv BADHAT_ENV DEV
#
# Default: PROD (secure by default - you must explicitly opt into DEV)
###############################################
<If "-z env('BADHAT_ENV')">
    SetEnv BADHAT_ENV PROD
</If>

###############################################
# Enforce max‐length limits
###############################################
LimitRequestLine      2048
LimitRequestFieldSize 2048
LimitRequestFields    50

###############################################
# BADHAT PHP Hardening & Resource Limits
###############################################
# Purpose:
#   • Apply security restrictions to mitigate common PHP
#     vulnerabilities (RFI, LFI, SSRF, code injection).
#   • Enforce resource usage limits to prevent DoS or
#     runaway scripts (memory/time exhaustion, huge uploads).
#
# Configuration breakdown:
#   open_basedir        – Restricts all file operations
#                         (include/require/fopen, etc.) to your
#                         application directories.
#   allow_url_include   – Disallow include/require() of remote URLs
#                         (blocks Remote File Inclusion attacks).
#   allow_url_fopen     – Disallow file functions (fopen, file_get_contents)
#                         from accessing remote URLs (blocks SSRF).
#   disable_functions   – Disable dangerous built-in functions that
#                         invoke the shell or eval arbitrary code.
#   memory_limit        – Caps memory per PHP process to avoid
#                         runaway RAM usage.
#   max_execution_time  – Caps script run-time to avoid long-running
#                         or hung processes.
#   post_max_size       – Limits total size of POST bodies (uploads).
#   max_input_vars      – Limits number of GET/POST/COOKIE variables
#                         (mitigate hash collisions, exploitation).
###############################################
php_admin_value open_basedir "${SITE_ROOT}/app/:${SITE_ROOT}/add/:/tmp"
php_admin_value allow_url_include Off
php_admin_value allow_url_fopen   Off
php_admin_value disable_functions "exec,system,shell_exec,passthru"
php_admin_value memory_limit      32M
php_admin_value max_execution_time 5
php_admin_value post_max_size     1M
php_admin_value max_input_vars    100

###############################################
# BADHAT: Session Security & Error Logging
###############################################
# Purpose:
#   • Enforce secure cookie handling to protect session data.
#   • Enable strict session ID validation to mitigate fixation attacks.
#   • Suppress PHP error output to users while still logging all relevant issues.
#   • Route errors cleanly into the server's error log with full detail.
#
# Configuration breakdown:
#   session.cookie_httponly    – Prevents JavaScript from accessing the session cookie.
#   session.cookie_secure      – Ensures cookies are only sent over HTTPS (PROD only).
#   session.use_strict_mode    – Rejects uninitialized or invalid session IDs.
#   display_errors             – Disables on-screen error messages for end users.
#   error_reporting            – Controls which levels of errors are reported.
#   error_log                  – Sends error messages to the webserver's stderr (Apache error log).
#   log_errors_max_len         – 0 = no truncation; log full error message.
#   ignore_repeated_errors     – 0 = log every occurrence, even duplicates.
#   html_errors                – Off = format errors in plain text, not HTML.
###############################################
php_admin_value session.cookie_httponly 1
php_admin_value session.use_strict_mode 1
php_admin_value display_errors    Off
php_admin_value error_reporting   "E_ALL"
php_admin_value error_log         /proc/self/fd/2
php_admin_value log_errors_max_len   0
php_admin_value ignore_repeated_errors 0
php_admin_value html_errors       Off

# Environment-aware: secure cookies only in PROD
<If "env('BADHAT_ENV') == 'PROD'">
    php_admin_value session.cookie_secure   1
</If>
<Else>
    php_admin_value session.cookie_secure   0
</Else>

###############################################
# BADHAT: Baseline Rewrite Rules
###############################################
# Purpose:
#   • Prevent directory browsing and disallowed file access.
#   • Enforce only safe HTTP methods (block uncommon/unsafe verbs).
#   • Mitigate path-traversal, null-byte injection, and dot-file exposure.
#   • Serve existing files/directories directly; route all other requests
#     to your front-controller (e.g., index.php) for centralized handling.
#
# Breakdown of directives:
#   <Directory>             – Scope these rules to your public webroot.
#   Options                – Disable unwanted Apache features.
#   AllowOverride None     – Prevent .htaccess overrides for consistency.
#   Require all granted    – Allow all requests (filtering is via RewriteRules).
#   AcceptPathInfo Off     – Disallow extra "/foo" path info if not needed.
#   RewriteEngine On       – Enable mod_rewrite.
#
#   RewriteCond/RewriteRule – Pattern + condition syntax for flexible blocking.
###############################################
<Directory "${SITE_ROOT}/public">
    Options -Indexes -MultiViews +FollowSymLinks
    AllowOverride None
    Require all granted
    AcceptPathInfo Off

    RewriteEngine On

    # Block bad HTTP methods
    RewriteCond %{REQUEST_METHOD} !^(GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS)$ [NC]
    RewriteRule .* - [F]

    # Block directory-traversal and null
    RewriteCond %{REQUEST_URI} \\.\\.           [OR]
    RewriteCond %{REQUEST_URI} (%2e){2}       [NC,OR]
    RewriteCond %{REQUEST_URI} %00            [NC]
    RewriteRule .* - [F]

    # Block dot-files
    RewriteRule "(^|/)\\." - [F]

    # Serve existing files or dirs
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # Fallback to front-controller
    RewriteRule ^ /index.php [QSA,L]
</Directory>

###############################################
# BADHAT: Core Security Headers (All Environments)
###############################################
# These headers are safe and beneficial in both DEV and PROD
###############################################

# Clickjacking prevention (dual approach for compatibility)
Header always set X-Frame-Options        "SAMEORIGIN"
Header always set Content-Security-Policy "frame-ancestors 'self'"

# MIME sniffing protection
Header always set X-Content-Type-Options "nosniff"

# Referrer privacy
Header always set Referrer-Policy        "strict-origin-when-cross-origin"

# Cache control variance
Header always set Vary "Accept-Encoding"

# Remove server fingerprinting
Header unset X-Powered-By
Header unset Server

###############################################
# BADHAT: Production-Only Security Headers
###############################################
# HSTS and strict cross-origin isolation only in PROD
# (these break HTTP dev servers like `php -S`)
###############################################
<If "env('BADHAT_ENV') == 'PROD'">
    # HSTS: Force HTTPS for 1 year, include subdomains, allow preload
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Cross-origin isolation (protocol-adaptive: more aggressive for HTTP/2+)
    <If "%{SERVER_PROTOCOL} =~ /HTTP\/2/ || %{SERVER_PROTOCOL} =~ /HTTP\/3/">
        Header always set Cross-Origin-Opener-Policy "same-origin"
        Header always set Cross-Origin-Embedder-Policy "require-corp"
    </If>
    <Else>
        Header always set Cross-Origin-Opener-Policy "same-origin-allow-popups"
        Header always set Cross-Origin-Embedder-Policy "unsafe-none"
    </Else>
</If>

###############################################
# BADHAT: Development-Only Headers
###############################################
# Helpful headers for local development
###############################################
<If "env('BADHAT_ENV') == 'DEV'">
    # Disable caching for development
    Header always set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header always set Pragma "no-cache"
    Header always set Expires "0"
    
    # Allow easier debugging (no CORS restrictions)
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
</If>

###############################################
# Protocol-Specific Connection Management
###############################################
# HTTP/1.1: Explicit keep-alive for connection reuse
# HTTP/2+: Connection headers harmful (multiplexing handles this)
###############################################
<If "%{SERVER_PROTOCOL} == 'HTTP/1.1'">
    Header always set Connection "Keep-Alive"
    Header always set Keep-Alive "timeout=5, max=100"
</If>


###############################################
# Compression: Protocol-Aware & Broad Coverage
###############################################
# Enable compression for all text-based and compressible MIME types
# Vary header already set above for proper cache segregation
###############################################
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/css text/plain text/xml
    AddOutputFilterByType DEFLATE application/javascript application/json
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml application/atom+xml
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE font/ttf font/otf font/woff font/woff2
</IfModule>

<IfModule mod_brotli.c>
    AddOutputFilterByType BROTLI_COMPRESS text/html text/css text/plain text/xml
    AddOutputFilterByType BROTLI_COMPRESS application/javascript application/json
    AddOutputFilterByType BROTLI_COMPRESS application/xml application/xhtml+xml
    AddOutputFilterByType BROTLI_COMPRESS application/rss+xml application/atom+xml
    AddOutputFilterByType BROTLI_COMPRESS image/svg+xml
    AddOutputFilterByType BROTLI_COMPRESS font/ttf font/otf font/woff font/woff2
</IfModule>
