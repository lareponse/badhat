<button id="accessibility-toggle" aria-label="Menu accessibilité">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm9 7h-6v13h-2v-6h-2v6H9V9H3V7h18v2z" />
    </svg>
</button>

<div id="accessibility-menu" aria-hidden="true" role="dialog" aria-labelledby="accessibility-title">
    <header>
        <h2 id="accessibility-title">Menu d'accessibilité</h2>
        <button id="close-menu" aria-label="Fermer le menu">
            <svg width="24" height="24" viewBox="0 0 24 24">
                <path
                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
            </svg>
        </button>
    </header>

    <div class="options" role="group" aria-labelledby="accessibility-title">
        <!-- Lire la page -->
        <button class="action" data-action="readPage" role="slider" aria-label="Lire la page" aria-valuemin="1"
            aria-valuemax="3" aria-valuenow="1">
            <span class="icon">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z" />
                </svg>
            </span>
            <span class="label">Lire la page</span>
            <span class="steps">
                <span class="step active"></span><span class="step"></span><span class="step"></span>
            </span>
        </button>

        <!-- Contraste -->
        <button class="action" data-action="contrast" role="slider" aria-label="Contraste" aria-valuemin="1"
            aria-valuemax="3" aria-valuenow="1">
            <span class="icon">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18V4c4.41 0 8 3.59 8 8s-3.59 8-8 8z" />
                </svg>
            </span>
            <span class="label">Contraste</span>
            <span class="steps">
                <span class="step active"></span><span class="step"></span><span class="step"></span>
            </span>
        </button>

        <!-- Contraste intelligent -->
        <button class="action" data-action="smartContrast" role="slider" aria-label="Contraste intelligent"
            aria-valuemin="1" aria-valuemax="3" aria-valuenow="1">
            <span class="icon">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path
                        d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6c3.31 0 6 2.69 6 6s-2.69 6-6 6z" />
                </svg>
            </span>
            <span class="label">Contraste intelligent</span>
            <span class="steps">
                <span class="step active"></span><span class="step"></span><span class="step"></span>
            </span>
        </button>

        <!-- Surligner les liens -->
        <button class="action" data-action="highlightLinks" role="slider" aria-label="Surligner les liens"
            aria-valuemin="1" aria-valuemax="3" aria-valuenow="1">
            <span class="icon">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path
                        d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z" />
                </svg>
            </span>
            <span class="label">Surligner les liens</span>
            <span class="steps">
                <span class="step active"></span><span class="step"></span><span class="step"></span>
            </span>
        </button>

        <!-- Taille du texte -->
        <button class="action" data-action="fontSize" role="slider" aria-label="Taille du texte" aria-valuemin="1"
            aria-valuemax="3" aria-valuenow="1">
            <span class="icon">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path d="M9 4v3h5v12h3V7h5V4H9zm-6 8h3v7h3v-7h3V9H3v3z" />
                </svg>
            </span>
            <span class="label">Taille du texte</span>
            <span class="steps">
                <span class="step active"></span><span class="step"></span><span class="step"></span>
            </span>
        </button>

        <!-- Mode dyslexie -->
        <button class="action" data-action="dyslexia" role="slider" aria-label="Mode dyslexie" aria-valuemin="1"
            aria-valuemax="3" aria-valuenow="1">
            <span class="icon">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path
                        d="M5 8.5c0-.83.67-1.5 1.5-1.5S8 7.67 8 8.5 7.33 10 6.5 10 5 9.33 5 8.5zm11 7c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5zm-6-2.5l2.2 7H10l-1.7-5.3L7 16v3H5V10h2v4.3L8.3 10H10l2 6.5z" />
                </svg>
            </span>
            <span class="label">Mode dyslexie</span>
            <span class="steps">
                <span class="step active"></span><span class="step"></span><span class="step"></span>
            </span>
        </button>

        <!-- Agrandir curseur -->
        <button class="action" data-action="bigCursor" role="slider" aria-label="Curseur" aria-valuemin="1"
            aria-valuemax="3" aria-valuenow="1">
            <span class="icon">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path d="M7 14l5-5 5 5z" />
                </svg>
            </span>
            <span class="label">Agrandir curseur</span>
            <span class="steps">
                <span class="step active"></span><span class="step"></span><span class="step"></span>
            </span>
        </button>

        <!-- Info-bulles -->
        <button class="action" data-action="tooltips" role="slider" aria-label="Info-bulles" aria-valuemin="1"
            aria-valuemax="3" aria-valuenow="1">
            <span class="icon">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
                </svg>
            </span>
            <span class="label">Info-bulles</span>
            <span class="steps">
                <span class="step active"></span><span class="step"></span><span class="step"></span>
            </span>
        </button>

        <!-- Plan de page -->
        <button class="action" data-action="pageStructure" role="slider" aria-label="Plan de page" aria-valuemin="1"
            aria-valuemax="3" aria-valuenow="1">
            <span class="icon">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
                </svg>
            </span>
            <span class="label">Plan de page</span>
            <span class="steps">
                <span class="step active"></span><span class="step"></span><span class="step"></span>
            </span>
        </button>

        <!-- Hauteur de ligne -->
        <button class="action" data-action="lineHeight" role="slider" aria-label="Hauteur de ligne" aria-valuemin="1"
            aria-valuemax="3" aria-valuenow="1">
            <span class="icon">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path
                        d="M6 7h2.5L5 3.5 1.5 7H4v10H1.5L5 20.5 8.5 17H6V7zm4-2v2h12V5H10zm0 14h12v-2H10v2zm0-6h12v-2H10v2z" />
                </svg>
            </span>
            <span class="label">Hauteur de ligne</span>
            <span class="steps">
                <span class="step active"></span><span class="step"></span><span class="step"></span>
            </span>
        </button>

        <!-- Aligner le texte -->
        <button class="action" data-action="textAlign" role="slider" aria-label="Alignement du texte" aria-valuemin="1"
            aria-valuemax="3" aria-valuenow="1">
            <span class="icon">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path d="M3 21h18v-2H3v2zm0-4h18v-2H3v2zm0-4h18v-2H3v2zm0-4h18V7H3v2zm0-6v2h18V3H3z" />
                </svg>
            </span>
            <span class="label">Aligner le texte</span>
            <span class="steps">
                <span class="step active"></span><span class="step"></span><span class="step"></span>
            </span>
        </button>

        <!-- Saturation -->
        <button class="action" data-action="saturation" role="slider" aria-label="Saturation" aria-valuemin="1"
            aria-valuemax="3" aria-valuenow="1">
            <span class="icon">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 2l-5.5 9h11z M12 22l5.5-9h-11z M3.5 9L12 2l-5.5 9z M20.5 9L12 2l5.5 9z" />
                </svg>
            </span>
            <span class="label">Saturation</span>
            <span class="steps">
                <span class="step active"></span><span class="step"></span><span class="step"></span>
            </span>
        </button>

        <!-- Réinitialiser -->
        <button class="action reset" data-action="reset" aria-label="Réinitialiser">
            <span class="icon">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path
                        d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" />
                </svg>
            </span>
            <span class="label">Réinitialiser</span>
        </button>
    </div>
</div>

<!-- Live region for screen reader announcements -->
<div id="a11y-announcements" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<style>
    /* Screen reader only class */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation: none !important;
            transition: none !important;
        }
    }

    /* Toggle button */
    #accessibility-toggle {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background: var(--primary, #224099);
        color: white;
        border: none;
        border-radius: 50%;
        width: 3rem;
        height: 3rem;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 999;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse 5s infinite;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    #accessibility-toggle:hover {
        transform: scale(1.1);
    }

    #accessibility-toggle:focus-visible {
        outline: 3px solid #ffe500;
        outline-offset: 2px;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(34, 64, 153, 0.7);
        }

        70% {
            transform: scale(1.08);
            box-shadow: 0 0 0 15px rgba(34, 64, 153, 0);
        }

        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(34, 64, 153, 0);
        }
    }

    /* Menu container */
    #accessibility-menu {
        position: fixed;
        top: 0;
        right: 0;
        width: min(100%, 28rem);
        z-index: 1000;
        height: 100%;
        background: white;
        border-left: 2px solid var(--border, #ddd);
        box-shadow: -2px 0 8px rgba(0, 0, 0, 0.2);
        padding: 1rem;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        will-change: transform;
/*        display: flex;
        flex-direction: column;
   */ }

    #accessibility-menu.active {
        transform: translateX(0);
    }

    /* Prevent body scroll when menu open */
    body.menu-open {
        overflow: hidden;
    }

    /* Header */
    #accessibility-menu header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border, #ddd);
    }

    #accessibility-menu h2 {
        font-size: 1.25rem;
        margin: 0;
        color: var(--primary, #224099);
    }

    #accessibility-menu #close-menu {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
    }

    #accessibility-menu #close-menu:hover {
        background: #f0f0f0;
    }

    #accessibility-menu #close-menu:focus-visible {
        outline: 2px solid var(--primary, #224099);
    }

    /* Options grid */
    #accessibility-menu .options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(7rem, 1fr));
        gap: 0.75rem;
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem 0;
    }

    /* Action buttons */
    #accessibility-menu .action {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        background: var(--color-surface-alt, #f8f8fa);
        border: 1px solid var(--color-border, #ddd);
        border-radius: 0.75rem;
        padding: 0.75rem 0.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        min-height: 7rem;
    }

    #accessibility-menu .action:hover {
        background: var(--color-accent-primary-light, #e3dbff);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    #accessibility-menu .action:focus-visible {
        outline: 2px solid var(--color-accent-primary, #224099);
        outline-offset: 2px;
    }

    #accessibility-menu .action.active-feature {
        background: #e3dbff;
        border-color: var(--primary, #224099);
    }

    /* Icons */
    #accessibility-menu .icon {
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary, #224099);
    }

    #accessibility-menu .icon svg {
        width: 1.5rem;
        height: 1.5rem;
        fill: currentColor;
    }

    /* Labels */
    #accessibility-menu .label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--color-text-primary, #222);
        line-height: 1.2;
    }

    /* Steps */
    #accessibility-menu .steps {
        display: flex;
        gap: 0.25rem;
        justify-content: center;
    }

    #accessibility-menu .step {
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 50%;
        background: var(--color-text-muted, #d5daed);
        transition: background 0.2s;
    }

    #accessibility-menu .step.active {
        background: var(--color-accent-primary, #224099);
    }

    /* Reset button */
    #accessibility-menu .action.reset {
        grid-column: 1 / -1;
        background: var(--color-accent-secondary, #ffe500);
        color: #000;
        font-weight: bold;
        min-height: 3rem;
        flex-direction: row;
        gap: 1rem;
    }

    #accessibility-menu .action.reset:hover {
        background: #ffd700;
    }

    /* Mobile responsive */
    @media (max-width: 480px) {
        #accessibility-menu {
            width: 100%;
        }

        #accessibility-menu .options {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Accessibility mode styles */
    body.high-contrast {
        filter: contrast(1.5);
        background: #000 !important;
    }

    body.high-contrast * {
        background-color: #000 !important;
        color: #fff !important;
        border-color: #fff !important;
    }

    body.inverted {
        filter: invert(1) hue-rotate(180deg);
    }

    body.inverted img,
    body.inverted video {
        filter: invert(1) hue-rotate(180deg);
    }

    body.smart-contrast {
        background: #1a1a1a !important;
    }

    body.smart-contrast * {
        color: #f0f0f0 !important;
    }

    body.smart-contrast a {
        color: #4a9eff !important;
    }

    body.highlight-links a {
        background: yellow !important;
        color: #000 !important;
        padding: 0.2em !important;
        text-decoration: underline !important;
    }

    body.highlight-links-strong a {
        background: #ff0 !important;
        color: #000 !important;
        padding: 0.3em !important;
        border: 2px solid #000 !important;
    }

    body.highlight-focus *:focus {
        outline: 3px solid #ff0 !important;
        outline-offset: 2px !important;
    }

    body.font-small {
        font-size: 90% !important;
    }

    body.font-large {
        font-size: 110% !important;
    }

    body.font-xlarge {
        font-size: 125% !important;
    }

    body.dyslexia-light {
        font-family: Arial, sans-serif !important;
        letter-spacing: 0.05em !important;
    }

    body.dyslexia-medium {
        font-family: "Comic Sans MS", Arial, sans-serif !important;
        letter-spacing: 0.1em !important;
        word-spacing: 0.2em !important;
    }

    body.dyslexia-strong {
        font-family: "OpenDyslexic", "Comic Sans MS", Arial, sans-serif !important;
        letter-spacing: 0.15em !important;
        word-spacing: 0.3em !important;
        line-height: 1.8 !important;
    }

    body.cursor-white * {
        cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><circle cx="16" cy="16" r="15" fill="white" stroke="black" stroke-width="2"/></svg>') 16 16, auto !important;
    }

    body.cursor-black * {
        cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><circle cx="16" cy="16" r="15" fill="black" stroke="white" stroke-width="2"/></svg>') 16 16, auto !important;
    }

    body.cursor-large * {
        cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><circle cx="24" cy="24" r="23" fill="yellow" stroke="black" stroke-width="2"/></svg>') 24 24, auto !important;
    }

    body.show-tooltips [title] {
        position: relative;
    }

    body.show-tooltips [title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 0.5em;
        border-radius: 4px;
        white-space: nowrap;
        z-index: 1000;
        font-size: 0.9em;
    }

    body.show-structure h1,
    body.show-structure h2,
    body.show-structure h3,
    body.show-structure h4,
    body.show-structure h5,
    body.show-structure h6 {
        border-left: 4px solid #224099 !important;
        padding-left: 0.5em !important;
        background: rgba(34, 64, 153, 0.1) !important;
    }

    body.show-structure-strong *[role],
    body.show-structure-strong nav,
    body.show-structure-strong main,
    body.show-structure-strong header,
    body.show-structure-strong footer,
    body.show-structure-strong section,
    body.show-structure-strong article {
        outline: 2px dashed #224099 !important;
        outline-offset: 2px !important;
    }

    body.line-height-small {
        line-height: 1.3 !important;
    }

    body.line-height-medium {
        line-height: 1.6 !important;
    }

    body.line-height-large {
        line-height: 2 !important;
    }

    body.line-height-medium * {
        line-height: inherit !important;
    }

    body.line-height-large * {
        line-height: inherit !important;
    }

    body.text-left * {
        text-align: left !important;
    }

    body.text-center * {
        text-align: center !important;
    }

    body.text-justify * {
        text-align: justify !important;
        hyphens: auto !important;
    }

    body.saturation-low {
        filter: saturate(0.5);
    }

    body.saturation-none {
        filter: saturate(0);
    }

    body.saturation-high {
        filter: saturate(1.5);
    }
</style>

<script>
    (function () {
        'use strict';

        // Elements
        const menu = document.getElementById('accessibility-menu');
        const toggleBtn = document.getElementById('accessibility-toggle');
        const closeBtn = document.getElementById('close-menu');
        const announcements = document.getElementById('a11y-announcements');

        // State
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let focusTrap = null;

        // Announce to screen readers
        function announce(text) {
            announcements.textContent = text;
            setTimeout(() => announcements.textContent = '', 3000);
        }

        // Focus trap for menu
        function initFocusTrap() {
            const focusableElements = menu.querySelectorAll(
                'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
            );

            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            focusTrap = (e) => {
                if (e.key !== 'Tab') return;

                if (e.shiftKey && document.activeElement === firstFocusable) {
                    e.preventDefault();
                    lastFocusable.focus();
                } else if (!e.shiftKey && document.activeElement === lastFocusable) {
                    e.preventDefault();
                    firstFocusable.focus();
                }
            };

            menu.addEventListener('keydown', focusTrap);
        }

        function removeFocusTrap() {
            if (focusTrap) {
                menu.removeEventListener('keydown', focusTrap);
                focusTrap = null;
            }
        }

        // Toggle menu
        function openMenu() {
            menu.classList.add('active');
            menu.setAttribute('aria-hidden', 'false');
            document.body.classList.add('menu-open');
            closeBtn.focus();
            initFocusTrap();
            announce('Menu d\'accessibilité ouvert');
        }

        function closeMenu() {
            menu.classList.remove('active');
            menu.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('menu-open');
            toggleBtn.focus();
            removeFocusTrap();
            announce('Menu d\'accessibilité fermé');
        }

        toggleBtn.addEventListener('click', openMenu);
        closeBtn.addEventListener('click', closeMenu);

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && menu.classList.contains('active')) {
                closeMenu();
            }
        });

        // Menu keyboard navigation with arrow keys
        menu.addEventListener('keydown', (e) => {
            const actions = Array.from(menu.querySelectorAll('.action'));
            const currentIndex = actions.indexOf(document.activeElement);

            let nextIndex = currentIndex;

            switch (e.key) {
                case 'ArrowRight':
                    nextIndex = (currentIndex + 1) % actions.length;
                    break;
                case 'ArrowLeft':
                    nextIndex = currentIndex - 1 < 0 ? actions.length - 1 : currentIndex - 1;
                    break;
                case 'ArrowDown':
                    nextIndex = Math.min(currentIndex + 3, actions.length - 1);
                    break;
                case 'ArrowUp':
                    nextIndex = Math.max(currentIndex - 3, 0);
                    break;
                default:
                    return;
            }

            if (nextIndex !== currentIndex) {
                e.preventDefault();
                actions[nextIndex].focus();
            }
        });

        // Text to speech
        function startReading(speed = 'normal') {
            if (!speechSynthesis) return;

            stopReading();

            const text = document.body.innerText || document.body.textContent;
            currentUtterance = new SpeechSynthesisUtterance(text);

            currentUtterance.lang = 'fr-FR';
            currentUtterance.rate = speed === 'slow' ? 0.7 : 1;
            currentUtterance.pitch = 1;
            currentUtterance.volume = 1;

            speechSynthesis.speak(currentUtterance);
            announce('Lecture de la page activée');
        }

        function stopReading() {
            if (speechSynthesis && speechSynthesis.speaking) {
                speechSynthesis.cancel();
                announce('Lecture de la page arrêtée');
            }
        }

        // Remove all accessibility classes
        function removeAllClasses() {
            const classes = [
                'high-contrast', 'inverted', 'smart-contrast',
                'highlight-links', 'highlight-links-strong', 'highlight-focus',
                'font-small', 'font-large', 'font-xlarge',
                'dyslexia-light', 'dyslexia-medium', 'dyslexia-strong',
                'cursor-white', 'cursor-black', 'cursor-large',
                'show-tooltips', 'show-structure', 'show-structure-strong',
                'line-height-small', 'line-height-medium', 'line-height-large',
                'text-left', 'text-center', 'text-justify',
                'saturation-low', 'saturation-none', 'saturation-high'
            ];

            classes.forEach(cls => document.body.classList.remove(cls));
        }

        // Apply feature by level
        function applyFeature(action, level) {
            // Remove previous levels of this feature
            const featureMap = {
                readPage: () => {
                    if (level === 1) stopReading();
                    if (level === 2) startReading('normal');
                    if (level === 3) startReading('slow');
                },
                contrast: () => {
                    document.body.classList.remove('high-contrast', 'inverted');
                    if (level === 2) document.body.classList.add('high-contrast');
                    if (level === 3) document.body.classList.add('inverted');
                },
                smartContrast: () => {
                    document.body.classList.remove('smart-contrast');
                    if (level >= 2) document.body.classList.add('smart-contrast');
                },
                highlightLinks: () => {
                    document.body.classList.remove('highlight-links', 'highlight-links-strong', 'highlight-focus');
                    if (level === 2) document.body.classList.add('highlight-links');
                    if (level === 3) {
                        document.body.classList.add('highlight-links-strong');
                        document.body.classList.add('highlight-focus');
                    }
                },
                fontSize: () => {
                    document.body.classList.remove('font-small', 'font-large', 'font-xlarge');
                    if (level === 1) document.body.classList.add('font-small');
                    if (level === 2) document.body.classList.add('font-large');
                    if (level === 3) document.body.classList.add('font-xlarge');
                },
                dyslexia: () => {
                    document.body.classList.remove('dyslexia-light', 'dyslexia-medium', 'dyslexia-strong');
                    if (level === 2) document.body.classList.add('dyslexia-light');
                    if (level === 3) document.body.classList.add('dyslexia-medium');
                },
                bigCursor: () => {
                    document.body.classList.remove('cursor-white', 'cursor-black', 'cursor-large');
                    if (level === 2) document.body.classList.add('cursor-white');
                    if (level === 3) document.body.classList.add('cursor-large');
                },
                tooltips: () => {
                    document.body.classList.remove('show-tooltips');
                    if (level >= 2) document.body.classList.add('show-tooltips');
                },
                pageStructure: () => {
                    document.body.classList.remove('show-structure', 'show-structure-strong');
                    if (level === 2) document.body.classList.add('show-structure');
                    if (level === 3) document.body.classList.add('show-structure-strong');
                },
                lineHeight: () => {
                    document.body.classList.remove('line-height-small', 'line-height-medium', 'line-height-large');
                    if (level === 1) document.body.classList.add('line-height-small');
                    if (level === 2) document.body.classList.add('line-height-medium');
                    if (level === 3) document.body.classList.add('line-height-large');
                },
                textAlign: () => {
                    document.body.classList.remove('text-left', 'text-center', 'text-justify');
                    if (level === 2) document.body.classList.add('text-left');
                    if (level === 3) document.body.classList.add('text-justify');
                },
                saturation: () => {
                    document.body.classList.remove('saturation-low', 'saturation-none', 'saturation-high');
                    if (level === 1) document.body.classList.add('saturation-low');
                    if (level === 2) document.body.classList.add('saturation-none');
                    if (level === 3) document.body.classList.add('saturation-high');
                }
            };

            if (featureMap[action]) {
                featureMap[action]();
            }
        }

        // Reset all accessibility settings
        function resetAccessibility() {
            // Stop reading if active
            stopReading();

            // Remove all classes
            removeAllClasses();

            // Reset all ARIA values
            document.querySelectorAll('[aria-valuenow]').forEach(el => {
                el.setAttribute('aria-valuenow', '1');
                const btn = el.closest('.action');
                if (btn) btn.classList.remove('active-feature');

                el.querySelectorAll('.step').forEach((step, i) => {
                    step.classList.toggle('active', i === 0);
                });
            });

            // Clear localStorage
            localStorage.removeItem('a11ySettings');

            announce('Paramètres d\'accessibilité réinitialisés');
        }

        // Save settings to localStorage
        function saveSettings() {
            const settings = {};

            document.querySelectorAll('.action[data-action]').forEach(btn => {
                if (btn.dataset.action !== 'reset') {
                    settings[btn.dataset.action] = btn.getAttribute('aria-valuenow') || '1';
                }
            });

            localStorage.setItem('a11ySettings', JSON.stringify(settings));
        }

        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('a11ySettings');
            if (!saved) return;

            try {
                const settings = JSON.parse(saved);

                Object.entries(settings).forEach(([action, level]) => {
                    const btn = document.querySelector(`[data-action="${action}"]`);
                    if (btn) {
                        const levelNum = parseInt(level);
                        btn.setAttribute('aria-valuenow', levelNum);

                        // Update visual steps
                        const steps = btn.querySelectorAll('.step');
                        steps.forEach((step, i) => {
                            step.classList.toggle('active', i < levelNum);
                        });

                        // Apply the feature
                        applyFeature(action, levelNum);

                        // Mark button as active if level > 1
                        if (levelNum > 1) {
                            btn.classList.add('active-feature');
                        }
                    }
                });

                announce('Paramètres d\'accessibilité restaurés');
            } catch (e) {
                console.error('Failed to load accessibility settings:', e);
            }
        }

        // Handle action buttons
        document.addEventListener('DOMContentLoaded', () => {
            const actions = document.querySelectorAll('.action');

            actions.forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;

                    // Handle reset
                    if (action === 'reset') {
                        resetAccessibility();
                        return;
                    }

                    // Get current level
                    const min = parseInt(btn.getAttribute('aria-valuemin')) || 1;
                    const max = parseInt(btn.getAttribute('aria-valuemax')) || 3;
                    let val = parseInt(btn.getAttribute('aria-valuenow')) || 1;

                    // Cycle to next level
                    val = val >= max ? min : val + 1;

                    // Update ARIA
                    btn.setAttribute('aria-valuenow', val);

                    // Update visual steps
                    const steps = btn.querySelectorAll('.step');
                    steps.forEach((step, i) => {
                        step.classList.toggle('active', i < val);
                    });

                    // Apply the feature
                    applyFeature(action, val);

                    // Update button state
                    if (val > 1) {
                        btn.classList.add('active-feature');
                    } else {
                        btn.classList.remove('active-feature');
                    }

                    // Save settings
                    saveSettings();

                    // Announce change
                    const label = btn.querySelector('.label').textContent;
                    const levelText = val === 1 ? 'désactivé' : `niveau ${val - 1}`;
                    announce(`${label} ${levelText}`);
                });

                // Add keyboard support for Space/Enter
                btn.addEventListener('keydown', (e) => {
                    if (e.key === ' ' || e.key === 'Enter') {
                        e.preventDefault();
                        btn.click();
                    }
                });
            });

            // Load saved settings on page load
            loadSettings();
        });

        // Prevent clicks outside menu from closing it accidentally
        menu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Monitor for preference changes
        if (window.matchMedia) {
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
            const prefersHighContrast = window.matchMedia('(prefers-contrast: high)');

            prefersReducedMotion.addEventListener('change', (e) => {
                if (e.matches) {
                    announce('Animations réduites détectées');
                }
            });

            prefersDark.addEventListener('change', (e) => {
                if (e.matches) {
                    announce('Mode sombre détecté');
                }
            });

            prefersHighContrast.addEventListener('change', (e) => {
                if (e.matches) {
                    announce('Contraste élevé détecté');
                    // Auto-apply high contrast if system has it
                    const contrastBtn = document.querySelector('[data-action="contrast"]');
                    if (contrastBtn && contrastBtn.getAttribute('aria-valuenow') === '1') {
                        contrastBtn.setAttribute('aria-valuenow', '2');
                        applyFeature('contrast', 2);
                        saveSettings();
                    }
                }
            });
        }

        // Add OpenDyslexic font dynamically if needed
        function loadDyslexicFont() {
            if (!document.getElementById('opendyslexic-font')) {
                const link = document.createElement('link');
                link.id = 'opendyslexic-font';
                link.rel = 'stylesheet';
                link.href = 'https://fonts.cdnfonts.com/css/opendyslexic';
                document.head.appendChild(link);
            }
        }

        // Check if dyslexia mode is saved and load font
        const saved = localStorage.getItem('a11ySettings');
        if (saved) {
            try {
                const settings = JSON.parse(saved);
                if (settings.dyslexia && parseInt(settings.dyslexia) === 3) {
                    loadDyslexicFont();
                }
            } catch (e) { }
        }

        // Performance optimization: Debounce resize events
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Adjust menu if needed on resize
                if (menu.classList.contains('active') && window.innerWidth <= 480) {
                    menu.style.width = '100%';
                }
            }, 250);
        });

        // Expose API for external use
        window.accessibilityMenu = {
            open: openMenu,
            close: closeMenu,
            reset: resetAccessibility,
            applyFeature: applyFeature,
            announce: announce
        };

    })();
</script>